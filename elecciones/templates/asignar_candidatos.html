<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asignar Candidatos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>Asignar Candidatos</h2>
                <p class="text-muted">Evento: <strong>{{ evento.nombre }}</strong></p>
                <p class="text-muted">Fecha: {{ evento.fecha_inicio|date:"d/m/Y H:i" }} a {{ evento.fecha_termino|date:"d/m/Y H:i" }}</p>
            </div>
        </div>

        <!-- JSON seguro con los IDs seleccionados (UUIDs) -->
        {{ candidatos_actuales|json_script:"initial-selected" }}

        <form method="post" id="form-asignar">
            {% csrf_token %}
            <input type="hidden" name="candidatos_globales" id="candidatos_globales">

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Seleccionar Votantes como Candidatos</h5>
                </div>
                <div class="card-body">
                    {% if page_obj %}
                        <div class="mb-3">
                            {% for persona in page_obj %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           name="candidatos" 
                                           value="{{ persona.id }}"
                                           id="persona_{{ persona.id }}">
                                    <label class="form-check-label" for="persona_{{ persona.id }}">
                                        <strong>{{ persona.nombre }}</strong>
                                        {% if persona.email %}
                                            <br><small class="text-muted">{{ persona.email }}</small>
                                        {% endif %}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No hay votantes disponibles para asignar como candidatos.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Paginación -->
            {% if page_obj.paginator.num_pages > 1 %}
                <nav aria-label="Paginación de votantes">
                    <ul class="pagination mb-4">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">Primera</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Primera</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Anterior</span>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Siguiente</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Última</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}

            <!-- Botones de acción -->
            <div class="d-grid gap-2 d-sm-flex">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> Guardar Candidatos
                </button>
                <a href="{% url 'panel_admin' %}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </form>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const eventoId = '{{ evento.id }}';
    const STORAGE_KEY = 'candidatos_evento_' + eventoId;
    const form = document.getElementById('form-asignar');
    const hiddenField = document.getElementById('candidatos_globales');

    // Recuperar selección previa del localStorage
    let globalSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

    // Fusionar con selección inicial del servidor
    const initialSelected = JSON.parse(document.getElementById('initial-selected').textContent || '[]');
    if (globalSet.size === 0 && initialSelected.length > 0) {
        initialSelected.forEach(id => globalSet.add(String(id)));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(globalSet)));
    }

    // Al cargar, marcar checkboxes según el set global
    document.querySelectorAll('input[name="candidatos"]').forEach(cb => {
        cb.checked = globalSet.has(cb.value);

        cb.addEventListener('change', () => {
            if (cb.checked) {
                globalSet.add(cb.value);
            } else {
                globalSet.delete(cb.value);
            }
            // Guardar siempre el estado global en localStorage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(globalSet)));
            hiddenField.value = Array.from(globalSet).join(',');
        });
    });

    // Al cargar la página, sincronizar el campo oculto con localStorage
    hiddenField.value = Array.from(globalSet).join(',');

    // Antes de enviar, leer directamente de localStorage y volcar TODO al campo oculto
    form.addEventListener('submit', (e) => {
        const finalSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));
        hiddenField.value = Array.from(finalSet).join(',');
    });
});
</script>

</body>
</html>
