<!DOCTYPE html>
<html lang="es" class="bg-gray-50 h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voto Confirmado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="h-full flex flex-col justify-center py-12 sm:px-6 lg:px-8">

    <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-10 px-6 shadow-xl ring-1 ring-gray-900/5 sm:rounded-xl sm:px-12 text-center border-t-4 border-blue-600">
            
            <!-- Icono dinámico (cambiaremos esto visualmente, pero por defecto es proceso) -->
            <div class="mx-auto h-16 w-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 text-3xl mb-6 animate-pulse" id="status-icon">
                <i class="bi bi-hourglass-split"></i>
            </div>

            <h3 id="title" class="text-2xl font-bold tracking-tight text-gray-900 mb-2">
                Procesando Voto
            </h3>
            
            <p id="message" class="text-sm text-gray-500 mb-8 leading-relaxed">
                Tu voto está siendo enviado a la blockchain de forma segura. <br>Esto puede tomar unos segundos...
            </p>

            <!-- Spinner Tailwind -->
            <div id="spinner" class="flex justify-center my-6">
                <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- Acciones (Ocultas inicialmente) -->
            <!-- Usamos 'flex' en la clase, pero style="display:none" lo ocultará. 
                 Cuando el JS quite el display:none, 'flex' tomará el control. -->
            <div id="actions" class="flex flex-col gap-3" style="display:none;">
                <a id="btn-panel" href="{% url 'panel_usuario' %}" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform active:scale-[0.98]">
                    Volver al Panel
                </a>
                <a id="btn-resultados" href="{% url 'resultados_evento' evento_id %}" class="w-full flex justify-center py-2.5 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                    Ver Resultados
                </a>
            </div>

            <!-- Alertas de Estado (Ocultas inicialmente) -->
            <div id="error" class="mt-6 rounded-md bg-red-50 p-4 text-sm text-red-700 border border-red-200" style="display:none;"></div>
            <div id="success" class="mt-6 rounded-md bg-green-50 p-4 text-sm text-green-700 border border-green-200" style="display:none;"></div>
            
        </div>
        
        <p class="text-center text-xs text-gray-400 mt-8 flex justify-center items-center gap-1">
            <i class="bi bi-shield-check"></i> Transacción segura blockchain
        </p>
    </div>

    <script>
        (function(){
            const eventoId = "{{ evento_id }}";
            const pollUrl = `/voto-status/${eventoId}/`;
            const spinner = document.getElementById('spinner');
            const actions = document.getElementById('actions');
            const errorBox = document.getElementById('error');
            const successBox = document.getElementById('success');
            const title = document.getElementById('title');
            const message = document.getElementById('message');
            const statusIcon = document.getElementById('status-icon');

            // Disable navigation while waiting by intercepting clicks
            function blockInteraction() {
                document.body.addEventListener('click', preventDefaults, true);
            }
            function unblockInteraction() {
                document.body.removeEventListener('click', preventDefaults, true);
            }
            function preventDefaults(e) { e.stopPropagation(); e.preventDefault(); }

            blockInteraction();

            async function checkStatus(){
                try{
                    const resp = await fetch(pollUrl, { credentials: 'same-origin' });
                    if(!resp.ok) throw new Error('Error consultando estado');
                    const data = await resp.json();
                    const status = (data.status || '').toLowerCase();

                    if(status === 'pending' || status === 'sent' || status === 'no_blockchain_config'){
                        // Still waiting
                        title.textContent = 'Enviando voto...';
                        message.textContent = 'Tu voto se está minando en la blockchain. Por favor no cierres esta ventana.';
                        return false;
                    }

                    if(status === 'success' || status === 'confirmed'){
                        // Success — Update UI
                        unblockInteraction();
                        spinner.style.display = 'none';
                        
                        // Actualizar icono a éxito
                        statusIcon.classList.remove('bg-blue-50', 'text-blue-600', 'animate-pulse');
                        statusIcon.classList.add('bg-green-100', 'text-green-600');
                        statusIcon.innerHTML = '<i class="bi bi-check-lg"></i>';
                        
                        title.textContent = '¡Voto Confirmado!';
                        title.classList.add('text-green-700');
                        
                        message.style.display = 'none'; // Hide original message
                        
                        actions.style.display = ''; // Show buttons (flex)
                        successBox.style.display = ''; // Show success alert
                        
                        // Countdown timer
                        let seconds = 5;
                        successBox.innerHTML = `<div class="flex items-center"><i class="bi bi-check-circle-fill mr-2"></i> Voto registrado correctamente.<br>Redirigiendo en <strong>${seconds}</strong>...</div>`;
                        
                        const countdown = setInterval(() => {
                            seconds--;
                            if (seconds > 0) {
                                successBox.innerHTML = `<div class="flex items-center"><i class="bi bi-check-circle-fill mr-2"></i> Voto registrado correctamente.<br>Redirigiendo en <strong>${seconds}</strong>...</div>`;
                            } else {
                                clearInterval(countdown);
                            }
                        }, 1000);
                        
                        // Redirect logic
                        setTimeout(()=>{ window.location.href = '{% url "panel_usuario" %}'; }, 5000);
                        return true;
                    }

                    if(status === 'failed'){
                        // Error — Show error UI
                        unblockInteraction();
                        spinner.style.display = 'none';
                        
                        // Actualizar icono a error
                        statusIcon.classList.remove('bg-blue-50', 'text-blue-600', 'animate-pulse');
                        statusIcon.classList.add('bg-red-100', 'text-red-600');
                        statusIcon.innerHTML = '<i class="bi bi-x-lg"></i>';

                        title.textContent = 'Error en el Envío';
                        message.style.display = 'none';

                        actions.style.display = '';
                        errorBox.style.display = '';
                        errorBox.innerHTML = '<i class="bi bi-exclamation-triangle-fill mr-1"></i> Ocurrió un error enviando el voto a la blockchain. Puedes reintentar desde tu panel.';
                        return true;
                    }

                    // default: keep waiting
                }catch(err){
                    console.error(err);
                    // show non-blocking warning
                    message.textContent = 'Sincronizando con la red...';
                }
                return false;
            }

            // Poll every 3 seconds until success or failed
            (async function loop(){
                let done = await checkStatus();
                if(!done) setTimeout(loop, 3000);
            })();

        })();
    </script>
</body>
</html>