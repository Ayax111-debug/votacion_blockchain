<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Voto Confirmado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card">
            <div class="card-body text-center">
                <h3 id="title">Gracias por votar</h3>
                <p id="message" class="lead">Tu voto está siendo enviado a la blockchain. Por favor espera...</p>

                <div id="spinner" class="my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                <div id="actions" class="d-flex justify-content-center gap-2" style="display:none;">
                    <a id="btn-panel" href="{% url 'panel_usuario' %}" class="btn btn-primary">Volver al Panel</a>
                    <a id="btn-resultados" href="{% url 'resultados_evento' evento_id %}" class="btn btn-outline-secondary">Ver Resultados</a>
                </div>

                <div id="error" class="alert alert-danger mt-3" style="display:none;"></div>
                <div id="success" class="alert alert-success mt-3" style="display:none;"></div>
            </div>
        </div>
    </div>
    <script>
        (function(){
            const eventoId = "{{ evento_id }}";
            const pollUrl = `/voto-status/${eventoId}/`;
            const spinner = document.getElementById('spinner');
            const actions = document.getElementById('actions');
            const errorBox = document.getElementById('error');
            const successBox = document.getElementById('success');
            const title = document.getElementById('title');
            const message = document.getElementById('message');

            // Disable navigation while waiting by intercepting clicks
            function blockInteraction() {
                document.body.addEventListener('click', preventDefaults, true);
            }
            function unblockInteraction() {
                document.body.removeEventListener('click', preventDefaults, true);
            }
            function preventDefaults(e) { e.stopPropagation(); e.preventDefault(); }

            blockInteraction();

            async function checkStatus(){
                try{
                    const resp = await fetch(pollUrl, { credentials: 'same-origin' });
                    if(!resp.ok) throw new Error('Error consultando estado');
                    const data = await resp.json();
                    const status = (data.status || '').toLowerCase();

                    if(status === 'pending' || status === 'sent' || status === 'no_blockchain_config'){
                        // still waiting
                        title.textContent = 'Enviando voto';
                        message.textContent = 'Tu voto se está enviando a la blockchain. Por favor espera...';
                        spinner.style.display = '';
                        actions.style.display = 'none';
                        errorBox.style.display = 'none';
                        successBox.style.display = 'none';
                        return false;
                    }

                    if(status === 'success' || status === 'confirmed'){
                        // success — show success and redirect shortly
                        unblockInteraction();
                        spinner.style.display = 'none';
                        actions.style.display = '';
                        successBox.style.display = '';
                        
                        // Countdown timer
                        let seconds = 5;
                        successBox.textContent = `Voto registrado en la blockchain. Serás redirigido al panel en ${seconds} segundos...`;
                        
                        const countdown = setInterval(() => {
                            seconds--;
                            if (seconds > 0) {
                                successBox.textContent = `Voto registrado en la blockchain. Serás redirigido al panel en ${seconds} segundos...`;
                            } else {
                                clearInterval(countdown);
                            }
                        }, 1000);
                        
                        // After 5 seconds redirect to panel
                        setTimeout(()=>{ window.location.href = '{% url "panel_usuario" %}'; }, 5000);
                        return true;
                    }

                    if(status === 'failed'){
                        // show error and let user go back
                        unblockInteraction();
                        spinner.style.display = 'none';
                        actions.style.display = '';
                        errorBox.style.display = '';
                        errorBox.textContent = 'Ocurrió un error enviando el voto a la blockchain. Puedes reintentar desde tu panel.';
                        return true;
                    }

                    // default: keep waiting
                }catch(err){
                    console.error(err);
                    // show non-blocking warning but keep polling
                    message.textContent = 'Error consultando el estado. Reintentando...';
                }
                return false;
            }

            // Poll every 3 seconds until success or failed
            (async function loop(){
                let done = await checkStatus();
                if(!done) setTimeout(loop, 3000);
            })();

        })();
    </script>
</body>
</html>