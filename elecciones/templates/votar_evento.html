<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Votar en {{ evento.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h3>Votar en {{ evento.nombre }}</h3>
        <form method="post">
            {% csrf_token %}
            <div class="list-group mb-3">
                {% for candidato in candidatos %}
                    <label class="list-group-item d-flex align-items-center">
                        <input type="radio" name="candidato" value="{{ candidato.persona.id }}" required class="me-3">
                        {% if candidato.persona.foto_url %}
                            <img src="{{ candidato.persona.foto_url }}" alt="{{ candidato.persona.nombre }}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:8px;">
                        {% endif %}
                        <span>{{ candidato.persona.nombre }}</span>
                    </label>
                {% empty %}
                    <p class="text-muted">No hay candidatos disponibles.</p>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary">Confirmar voto</button>
            <a href="{% url 'panel_usuario' %}" class="btn btn-secondary">Volver</a>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const loadingMessage = document.getElementById('loading-message');
        loadingMessage.style.display = 'none'; // Hide loading message initially

        form.addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(form);
            loadingMessage.style.display = 'block'; // Show loading message

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to submit vote');
                }

                const data = await response.json();

                if (data.success) {
                    // Redirect to the event-specific confirmation page
                    window.location.href = "{% url 'voto_confirmado' evento.id %}";
                } else {
                    throw new Error('Vote submission failed');
                }
            } catch (error) {
                console.error('Error submitting vote:', error);
                alert('An error occurred while submitting your vote. Please try again.');
                loadingMessage.style.display = 'none';
            }
        });
    });
    </script>

    <div id="loading-message">
        <p>Processing your vote, please wait...</p>
    </div>
</body>
</html>
